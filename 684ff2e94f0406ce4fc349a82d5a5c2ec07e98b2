{
  "comments": [
    {
      "key": {
        "uuid": "7b70cf9a_30547e28",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1008909
      },
      "writtenOn": "2018-10-11T12:42:57Z",
      "side": 1,
      "message": "Are permissions checked somewhere above this point? This is a setattr operation and that just gets issued against a filehandle. How do we know that the caller has the correct permissions to do this?",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "7e83389b_fe56a50f",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1008909
      },
      "writtenOn": "2018-10-11T13:00:08Z",
      "side": 1,
      "message": "I don\u0027t know gluster well at all, but why do we need to do this for a setattr? If this change is to handle state being torn down, then do we really need to change truncate behavior? We shouldn\u0027t need to do any truncating to handle that situation.",
      "parentUuid": "7b70cf9a_30547e28",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "00490751_55002c17",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1004333
      },
      "writtenOn": "2018-10-11T13:26:07Z",
      "side": 1,
      "message": "Beyond this point, permissions are checked by the gluster server. Hence we need to set the right credentials (of the caller doing fop) at this point.\n\n\u003e\u003e  but why do we need to do this for a setattr?\n\na) Do you mean why do we need to set credentials for setattr?  or\nFor any I/O operation, gluster/gfapi expects applications (NFS-Ganesha) to set right credentials to pass through glusterfs server permission checks. Hence we set and reset credentials before and after each fop.\n\nb) why I changed it to read from my_fd now instead of op_ctx?\nThis particular change was more needed for fops which can happen without client intervention like  locks, leases, etc ( callbacks from backend) or close (while purging entry from cache). To maintain uniformity, I changed for other fops as well as \"find_fd()\" makes sure we set right credentials (in this case of setattr from op_ctx) and there shouldn\u0027t be any issues reading them back from my_fd.",
      "parentUuid": "7e83389b_fe56a50f",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "137b92ee_495ea40f",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1008909
      },
      "writtenOn": "2018-10-11T13:32:30Z",
      "side": 1,
      "message": "My worry is this:\n\nSuppose we get an ATTR_SIZE SETATTR RPC, with credentials that would be denied. We then go and find an existing file descriptor (my_fd), and proceed to use the credentials associated with it, which do have permissions to truncate the file. File is truncated even though it should have failed.\n\nWhat prevents the above situation?",
      "parentUuid": "00490751_55002c17",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "077fafa9_2325ea32",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1004333
      },
      "writtenOn": "2018-10-11T14:00:23Z",
      "side": 1,
      "message": "Hmm..right! For my understanding -\nmy_fd refers to \ncase (a) an existing fd associated with the state sent by client \ncase (b) or a global fd \ncase (c) or a temporary one. In case if its temporary, we set creds from op_ctx. So we are safe\n\nBut if its global fd (case b), then we may be using credentials which were initially used to open it which are incorrect. \n\nIn case of (a), can it happen that client had a particular open/lock state on a file but changed creds while doing setattr and in ganesha we found fd associated with that outstanding state with incorrect creds? If so, can it happen for any other fops too? \n\nPlease provide your inputs.",
      "parentUuid": "137b92ee_495ea40f",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "164ae41d_636ced4b",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2018-10-11T14:38:16Z",
      "side": 1,
      "message": "Ganesha has already fully permission checked setattr before calling into the FSAL.\n\nThe FSAL primarily needs to set credentials for calls into the filesystem for the following cases:\n\nDirectory operations (create, link, unlink, rename) - because Ganesha can\u0027t atomically check permissions and perform the operation, this is particularly an issue for rename.\n\nOperations (particularly I/O and create) that have quota implications.\n\nOperations (like create) that need the credentials to properly set or update metadata.\n\nThere\u0027s probably some other corner cases I\u0027m missing...",
      "parentUuid": "137b92ee_495ea40f",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "fcbd6b82_740a0904",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1004333
      },
      "writtenOn": "2018-10-11T17:43:53Z",
      "side": 1,
      "message": "Thanks Frank. But one case (which I can think of) where we need to set right (client) credentials before performing each fop is when ganesha process is run by non-root user which may not have permissions to access a particular file. Right?",
      "parentUuid": "164ae41d_636ced4b",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    },
    {
      "key": {
        "uuid": "a6d2d677_aa141976",
        "filename": "src/FSAL/FSAL_GLUSTER/handle.c",
        "patchSetId": 3
      },
      "lineNbr": 2653,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2018-10-11T18:21:27Z",
      "side": 1,
      "message": "That\u0027s an example of the kind of place where non-root Ganesha may have challenges...",
      "parentUuid": "fcbd6b82_740a0904",
      "revId": "684ff2e94f0406ce4fc349a82d5a5c2ec07e98b2",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735",
      "unresolved": true
    }
  ]
}