{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "82379860_5e1dfef9",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-24T21:00:16Z",
      "side": 1,
      "message": "When does this occur that a state_t has no state_exp attached? Please add more description of the issue to the commit message.\n\nI want to understand if this is actually the correct fix, or is sweeping something under the rug.",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "73dec205_cdcdf3a0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-24T21:52:32Z",
      "side": 1,
      "message": "I think there are two patches addressing the same underlying issue, the other patch is:\n\nhttps://review.gerrithub.io/c/ffilz/nfs-ganesha/+/539537",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "1b099832_30379d6f",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-27T00:03:28Z",
      "side": 1,
      "message": "Thanks the reply, actually I do not find why state_exp is NULL, but ganesha actually core at this position, and in coredump, I find state_exp is NULL.",
      "parentUuid": "82379860_5e1dfef9",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8e872e64_4d73f3b8",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-27T00:23:17Z",
      "side": 1,
      "message": "I will continue to find the root cause",
      "parentUuid": "1b099832_30379d6f",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5949d59f_efb66d72",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-27T15:36:44Z",
      "side": 1,
      "message": "Do you have stack back trace? You COULD be hitting the issue in the other patch, though looking at the code I never see state_exp being set to NULL.\n\nActually, I think we need to eliminate use of state_exp. Anything that works on a state SHOULD have op_ctx set up with the proper export, so we should just be able to use op_ctx-\u003efsal_export.\n\nLet me contemplate this and put forth an alternate patch.\n\nIn the meantime, it would still be good to understand how state_exp got to be NULL.",
      "parentUuid": "8e872e64_4d73f3b8",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ddc61ed5_092099c6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-27T23:31:13Z",
      "side": 1,
      "message": "See this patch as a better solution: https://review.gerrithub.io/c/ffilz/nfs-ganesha/+/540556\n\nI AM still interested in the cause of this. The state_exp pointer is never set to NULL, so it may be a use after free situation.",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "281545c6_a3baeb24",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-27T23:43:19Z",
      "side": 1,
      "message": "The stack is nfs_worker_thread.c:nfs_rpc_process_request -\u003e nfs4_Compound.c:nfs4_Compound -\u003e nfs4_Compound.c:process_one_op -\u003e nfs4_op_read.c:nfs4_op_read -\u003e nfs4_op_read.c:nfs4_read -\u003e sal_functions.h:dec_state_t_ref -\u003e nfs4_state_id.c:dec_nfs4_state_ref.\n\nI check a lot of coredump, all of them core at the same above stack. Besides, sometimes the state-\u003estate_exp is not NULL, but is a very short address. Sometimes, \nstate-\u003estate_exp is valid, but when gdb print state-\u003estate_exp-\u003eexp_ops, it report \"Cannot access memory at address xxx\"",
      "parentUuid": "5949d59f_efb66d72",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "84283f76_38e05d5e",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-28T00:58:52Z",
      "side": 1,
      "message": "sure, will continue to find the root cause",
      "parentUuid": "ddc61ed5_092099c6",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "042861db_d6f91b2d",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-28T03:53:42Z",
      "side": 1,
      "message": "OK, that sounds like corruption, or again, use after free. Could you share the results of \"print state\"? I\u0027m curious what the refcount and other fields are.\n\nAlso, do you have a short recreate for this or does it take some time?",
      "parentUuid": "281545c6_a3baeb24",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "026b161f_f6686f70",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-28T04:39:50Z",
      "side": 1,
      "message": "{state_list \u003d {next \u003d 0x7f92cc041210, prev \u003d 0x0}, state_owner_list \u003d {next \u003d 0x7f9200706900, prev \u003d 0x100000000}, state_export_list \u003d {\n    next \u003d 0x7f92cc041230, prev \u003d 0x0}, state_mutex \u003d {__data \u003d {__lock \u003d 825110528, __count \u003d 825112886, __owner \u003d 859058478, __nusers \u003d 32512,\n      __kind \u003d -1, __spins \u003d 32658, __elision \u003d 0, __list \u003d {__prev \u003d 0x0, __next \u003d 0x7f9200706900}},\n    __size \u003d \"\\000\\060.169.1.143\\000\\177\\000\\000\\377\\377\\377\\377\\222\\177\", \u0027\\000\u0027 \u003crepeats 11 times\u003e, \"ip\\000\\222\\177\\000\",\n    __align \u003d 3543832861703286784}, state_export \u003d 0x100000000, state_owner \u003d 0x7f92cc041270, state_obj \u003d 0x0, state_exp \u003d 0x0, state_data \u003d {share \u003d {\n      share_lockstates \u003d {next \u003d 0x7f92cc041278, prev \u003d 0x7f92cc041290}, share_access \u003d 0, share_deny \u003d 0, share_access_prev \u003d 1684632320,\n      share_deny_prev \u003d 32512}, nlm_share \u003d {share_perclient \u003d {next \u003d 0x7f92cc041278, prev \u003d 0x7f92cc041290}, share_access \u003d 0, share_deny \u003d 0,\n      share_access_counts \u003d {1684632320, 32512, 0, 1}, share_deny_counts \u003d {3422818992, 32658, 0, 0}}, lock \u003d {state_locklist \u003d {\n        next \u003d 0x7f92cc041278, prev \u003d 0x7f92cc041290}, state_sharelist \u003d {next \u003d 0x0, prev \u003d 0x7f0064697300}, openstate \u003d 0x100000000}, deleg \u003d {\n      sd_type \u003d 3422818936, sd_state \u003d (DELEG_RECALL_WIP | unknown: 32656), sd_clfile_stats \u003d {cfd_rs_time \u003d 140268464771728, cfd_r_time \u003d 0},\n      share_access \u003d 1684632320, share_deny \u003d 32512}, layout \u003d {state_segments \u003d {next \u003d 0x7f92cc041278, prev \u003d 0x7f92cc041290},\n      state_layout_type \u003d 0, granting \u003d 0, state_return_on_close \u003d false}, fid \u003d {state_locklist \u003d {next \u003d 0x7f92cc041278, prev \u003d 0x7f92cc041290},\n      share_access \u003d 0, share_deny \u003d 0}, io_advise \u003d 3422818936}, state_type \u003d 14592, state_seqid \u003d 0, state_refcount \u003d 0,\n  stateid_other \u003d \"\\000\\000\\000\\000\\320\\022\\004Ì’\\177\\000\", state_refer \u003d {session \u003d \"\\000\\000\\000\\000\\000\\000\\000\\000\\000pcode\\000\", sequence \u003d 0,\n    slot \u003d 1}}",
      "parentUuid": "042861db_d6f91b2d",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "5ce38eea_50282718",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-06-28T04:40:35Z",
      "side": 1,
      "message": "I do not know how to recreate it, it actually need some time.",
      "parentUuid": "026b161f_f6686f70",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7941c2c0_e807f1b0",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 2
      },
      "lineNbr": 0,
      "author": {
        "id": 1019791
      },
      "writtenOn": "2022-07-12T11:13:29Z",
      "side": 1,
      "message": "Hi, I think I found the root cause. It\u0027s a used after free.\n\u003d\u003d358416\u003d\u003dERROR: AddressSanitizer: heap-use-after-free on address 0x61100468f578 at pc 0x000000dff043 bp 0x7f59901b7ec0 sp 0x7f59901b7eb8\nWRITE of size 4 at 0x61100468f578 thread T2429\n    #0 0xdff042 in atomic_add_int32_t bytenas-ganesha/src/include/abstract_atomic.h:271\n    #1 0xdff042 in atomic_inc_int32_t bytenas-ganesha/src/include/abstract_atomic.h:292\n    #2 0xdff042 in inc_state_t_ref bytenas-ganesha/src/include/sal_functions.h:390\n    #3 0xdff042 in nfs4_read bytenas-ganesha/src/Protocols/NFS/nfs4_op_read.cc:467\n    #4 0xe00497 in nfs4_op_read(nfs_argop4*, compound_data*, nfs_resop4*) bytenas-ganesha/src/Protocols/NFS/nfs4_op_read.cc:741\n    #5 0xaa221e in process_one_op(compound_data*, nfsstat4*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:940\n    #6 0xaa6303 in nfs4_Compound(nfs_arg__*, svc_req*, nfs_res__*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:1365\n    #7 0xbaf27b in nfs_rpc_process_request bytenas-ganesha/src/MainNFSD/nfs_worker_thread.cc:1631\n    #8 0x7f5a3b0dbdbb in svc_request (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x22dbb)\n    #9 0x7f5a3b0d9110 in svc_rqst_xprt_task_recv (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x20110)\n    #10 0x7f5a3b0d9b37 in svc_rqst_epoll_loop (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x20b37)\n    #11 0x7f5a3b0e4db9 in work_pool_thread (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x2bdb9)\n    #12 0x7f5a374ceca8 in start_thread /data00/jenkins/workspace/gcc8_x86_64/src/glibc/nptl/pthread_create.c:486\n    #13 0x7f5a35bb276e in __clone (/opt/tiger/ganesha_deploy/lib/libc.so.6+0xf276e)\n\n0x61100468f578 is located 184 bytes inside of 240-byte region [0x61100468f4c0,0x61100468f5b0)\nfreed by thread T2930 here:\n    #0 0x7f5a3cc4e000 in __interceptor_free /data00/jenkins/workspace/gcc8_x86_64/src/gcc/libsanitizer/asan/asan_malloc_linux.cc:66\n    #1 0xbe17f4 in mdcache_free_state bytenas-ganesha/src/FSAL/Stackable_FSALs/FSAL_MDCACHE/mdcache_export.cc:788\n    #2 0x8804b1 in dec_nfs4_state_ref(state_t*) bytenas-ganesha/src/SAL/nfs4_state_id.cc:518\n    #3 0xe420fb in dec_state_t_ref bytenas-ganesha/src/include/sal_functions.h:412\n    #4 0xe420fb in nfs4_op_lock(nfs_argop4*, compound_data*, nfs_resop4*) bytenas-ganesha/src/Protocols/NFS/nfs4_op_lock.cc:716\n    #5 0xaa221e in process_one_op(compound_data*, nfsstat4*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:940\n    #6 0xaa6303 in nfs4_Compound(nfs_arg__*, svc_req*, nfs_res__*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:1365\n    #7 0xbaf27b in nfs_rpc_process_request bytenas-ganesha/src/MainNFSD/nfs_worker_thread.cc:1631\n    #8 0x7f5a3b0dbdbb in svc_request (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x22dbb)\n\npreviously allocated by thread T393 here:\n    #0 0x7f5a3cc4e568 in __interceptor_calloc /data00/jenkins/workspace/gcc8_x86_64/src/gcc/libsanitizer/asan/asan_malloc_linux.cc:95\n    #1 0xd0b403 in nas_alloc_state(fsal_export*, state_type, state_t*) bytenas-ganesha/src/FSAL/FSAL_NAS/handle.cc:921\n    #2 0xbe1706 in mdcache_alloc_state bytenas-ganesha/src/FSAL/Stackable_FSALs/FSAL_MDCACHE/mdcache_export.cc:765\n    #3 0xe8e29d in open4_ex bytenas-ganesha/src/Protocols/NFS/nfs4_op_open.cc:943\n    #4 0xea3ee4 in nfs4_op_open(nfs_argop4*, compound_data*, nfs_resop4*) bytenas-ganesha/src/Protocols/NFS/nfs4_op_open.cc:1389\n    #5 0xaa221e in process_one_op(compound_data*, nfsstat4*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:940\n    #6 0xaa6303 in nfs4_Compound(nfs_arg__*, svc_req*, nfs_res__*) bytenas-ganesha/src/Protocols/NFS/nfs4_Compound.cc:1365\n    #7 0xbaf27b in nfs_rpc_process_request bytenas-ganesha/src/MainNFSD/nfs_worker_thread.cc:1631\n    #8 0x7f5a3b0dbdbb in svc_request (/opt/tiger/ganesha_deploy/lib/libntirpc.so.3.2+0x22dbb)",
      "parentUuid": "84283f76_38e05d5e",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "c408a3ba_850b16d8",
        "filename": "src/SAL/nlm_state.c",
        "patchSetId": 2
      },
      "lineNbr": 484,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-06-21T11:25:55Z",
      "side": 1,
      "message": "WARNING: line over 80 characters\n+\t\t\tstate-\u003estate_exp-\u003eexp_ops.free_state(state-\u003estate_exp, state);",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9fd66dbd_1dd83abb",
        "filename": "src/SAL/nlm_state.c",
        "patchSetId": 2
      },
      "lineNbr": 484,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-06-24T21:00:16Z",
      "side": 1,
      "message": "Please fix this long line.",
      "parentUuid": "c408a3ba_850b16d8",
      "revId": "76829dc75eb0a22bbc8b2a0b33145b78819045e4",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}