{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "1bedb1c0_fd27f728",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 10
      },
      "lineNbr": 0,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "Cool",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "57d778cf_5602d523",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 10
      },
      "lineNbr": 0,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-18T13:31:05Z",
      "side": 1,
      "message": "I admit, I don\u0027t know much about Prometheus or Graphana, so just a few nits here, while I digest things.",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cddaa1dc_ca0df790",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "This goes over all clients - the loop\u0027s cost will only go up with time. If you use an LRU you can iterate just the active clients, and stop on the first inactive one.\nYou can also prune based on that",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "bf0f28fd_f8f562d5",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-18T13:31:05Z",
      "side": 1,
      "message": "True, but you trade off activity in this isolated thread for activity in the hot-path of operations, so maybe this is a good solution after all?",
      "parentUuid": "cddaa1dc_ca0df790",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "35da1b51_aba3f0d6",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T13:36:20Z",
      "side": 1,
      "message": "That\u0027s a good point. Still, clientActivity does need to be pruned, no?\n\nActually, if you just prune here based on durationSeconds you get the same behavior as with LRU - the loop\u0027s cost will be roughly the number of active clients in a set amount of time (the prune threshold + the thread\u0027s timer)",
      "parentUuid": "bf0f28fd_f8f562d5",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "2b1b891a_30985eec",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "I removed monitoring of client activity. Let\u0027s add that as a separate change and focus on all the other plumbing.",
      "parentUuid": "35da1b51_aba3f0d6",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d3009aa2_222eab70",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-20T13:39:56Z",
      "side": 1,
      "message": "I missed that there was a separate list.  That needs pruning, of course.  What\u0027s the reason for not using the actual client list?  I guess you\u0027ll have to lock it, so that may be a good enough reason.",
      "parentUuid": "35da1b51_aba3f0d6",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "2e5b51f9_e30616ae",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-21T00:54:31Z",
      "side": 1,
      "message": "On second thought, I think the monitoring stack should report the \"last activity per client\" only, not the \"active client count\". The \"active client count\" can be calculated by Prometheus.\n\nI will:\n1. Add the code back to report last client activity.\n2. Update the Prometheus rules to calculate this.",
      "parentUuid": "d3009aa2_222eab70",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "eed0dd17_4c7ab7bd",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 278,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-22T06:31:08Z",
      "side": 1,
      "message": "This has been addressed in patch set #13.",
      "parentUuid": "2e5b51f9_e30616ae",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "3a36fde5_429a6b9f",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 303,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "The comment in monitoring_register_export_label() seems to imply we\u0027re never allowed to free the memory pointed to by exportLabels entries (\"... as the label is returned as a char* to C code\")",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "99cade4e_8d16b9de",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 303,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "Great catch. The export label isn\u0027t returned as char* to C code anymore. I changed GetExportLabel() to return a string copy, so that the entry in exportLabels can be updated.",
      "parentUuid": "3a36fde5_429a6b9f",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "9e7d9389_918d2d0a",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 319,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "Calling GetExportLabel() but the result is ignored if export_id\u003d\u003d0",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "f33aabff_0afc93b3",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 319,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "Moved it further down.",
      "parentUuid": "9e7d9389_918d2d0a",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "26a3d3dd_ebd3368b",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 422,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "Ditto (ignored if export_id\u003d\u003d0)",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "24e88774_37b01e42",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 422,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "26a3d3dd_ebd3368b",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "198e5bc0_c6cdfe9b",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 476,
      "author": {
        "id": 1020351
      },
      "writtenOn": "2022-07-18T07:16:42Z",
      "side": 1,
      "message": "Ditto (can do like monitoring_mdcache_cache_miss() below and inline the variable)",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "9a66cccc_96d32ed9",
        "filename": "src/monitoring/monitoring.cc",
        "patchSetId": 10
      },
      "lineNbr": 476,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "Done",
      "parentUuid": "198e5bc0_c6cdfe9b",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "cb9e2190_7b9af7ac",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-07-18T04:05:12Z",
      "side": 1,
      "message": "ERROR: spaces required around that \u0027\u003c\u0027 (ctx:VxV)\n+extern std::unique_ptr\u003cprometheus::Exposer\u003e exposer;\n                       ^",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "0283dfbf_3b8b4519",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-07-18T04:05:12Z",
      "side": 1,
      "message": "ERROR: spaces required around that \u0027\u003e\u0027 (ctx:VxW)\n+extern std::unique_ptr\u003cprometheus::Exposer\u003e exposer;\n                                           ^",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "95ec49f5_a7716b10",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:35:09Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "cb9e2190_7b9af7ac",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "32206afa_1051ef86",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:35:09Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "0283dfbf_3b8b4519",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8ff45f3d_a02edd47",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-20T13:39:56Z",
      "side": 1,
      "message": "Ouch.  Clearly these checks don\u0027t work for C++ code.  Frank?  Any way we can disable them for C++ only?",
      "parentUuid": "32206afa_1051ef86",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "fd139ab8_b5922f7e",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 44,
      "author": {
        "id": 1003571
      },
      "writtenOn": "2022-07-20T17:02:59Z",
      "side": 1,
      "message": "Yea, I\u0027m not sure. Let\u0027s see how many of these we get.",
      "parentUuid": "8ff45f3d_a02edd47",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "f39ec852_e0d4bd03",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 45,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-07-18T04:05:12Z",
      "side": 1,
      "message": "ERROR: spaces required around that \u0027\u003c\u0027 (ctx:VxV)\n+extern std::shared_ptr\u003cprometheus::Registry\u003e registry;\n                       ^",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ad2261ad_41307111",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 45,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-07-18T04:05:12Z",
      "side": 1,
      "message": "ERROR: spaces required around that \u0027\u003e\u0027 (ctx:VxW)\n+extern std::shared_ptr\u003cprometheus::Registry\u003e registry;\n                                            ^",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "ecf3e72b_7703968a",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 45,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:35:09Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "f39ec852_e0d4bd03",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "90499020_34f11686",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 45,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:35:09Z",
      "side": 1,
      "message": "Ack",
      "parentUuid": "ad2261ad_41307111",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "1569864b_248b2845",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 47,
      "author": {
        "id": 1005370
      },
      "writtenOn": "2022-07-18T04:05:12Z",
      "side": 1,
      "message": "ERROR: need consistent spacing around \u0027\u0026\u0027 (ctx:WxV)\n+const std::string \u0026GetExportLabel(export_id_t export_id);\n                   ^",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "7c763bb1_4bba9e60",
        "filename": "src/monitoring/monitoring_internal.h",
        "patchSetId": 10
      },
      "lineNbr": 47,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:35:09Z",
      "side": 1,
      "message": "Removed \u0026",
      "parentUuid": "1569864b_248b2845",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "e23c822e_806499ba",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-18T13:31:05Z",
      "side": 1,
      "message": "I think there may be a problem with these.  There appears to be a single instance of max and min in the monitoring code, but there are may thread fridges, so this will get called for each one.  It seems that the last-one-in will overwrite the others?",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "c3d11f69_98b7a7e0",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-20T05:32:21Z",
      "side": 1,
      "message": "Yes, only the last one counts. But this function is only called from 9p_dispatcher.c (line 453) so it looks like there\u0027s only one thread pool created.",
      "parentUuid": "e23c822e_806499ba",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "90c5dcef_f6a568a7",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-20T13:39:56Z",
      "side": 1,
      "message": "Good point.  That means this isn\u0027t doing what it looks like it\u0027s doing, which is counting threads.  Most threads come from ntirpc, and the rest come from individual thread fridges.  This one contributes basically nothing, since it\u0027s 9P only.  What stat is this supposed to be reporting, and do we think it\u0027s useful, given the above issues?",
      "parentUuid": "c3d11f69_98b7a7e0",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "16627a8e_a98ed87a",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-21T00:54:31Z",
      "side": 1,
      "message": "But it looks to me as if the 9P worker thread pool is the one that handles NFS requests, so this is actually the NFS worker thread pool. If I got that wrong, where is the NFS worker thread pool created?\n\nThe point of all this is to be able to tune Ganesha and understand what\u0027s going on. These thread numbers may look odd by themselves, but when you also combine them with:\n1. Number of rpcs received / processed.\n2. Number of operations in flight.\n3. (tail) Latency percentiles of operations.\nThen you can build an accurate view of what Ganesha is up to, and where bottlenecks are forming. As an example, it\u0027s straight forward to spot if rpcs are queuing up because of worker thread starvation.\n\nThe min/max number of threads are actually gauges (can be incremented / decremented). Let me change these from set functions to increment / decrement functions. Then it will work for any number of worker thread pools.",
      "parentUuid": "90c5dcef_f6a568a7",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "a4cb86f5_526f6857",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1015854
      },
      "writtenOn": "2022-07-22T06:31:08Z",
      "side": 1,
      "message": "This has been addressed in patch set #13.",
      "parentUuid": "16627a8e_a98ed87a",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "08be496e_878ff3f6",
        "filename": "src/support/fridgethr.c",
        "patchSetId": 10
      },
      "lineNbr": 1447,
      "author": {
        "id": 1004087
      },
      "writtenOn": "2022-07-22T13:10:52Z",
      "side": 1,
      "message": "Actual NFS OPs are processed by threads from NTIRPC, specifically from the svc_work_pool.  Ganesha controls the configured min and max for this thread pool (via the rpc_ioq_thrdmin and rpc_ioq_thrdmax config options in the core parameters), but the threads themselves come from NTIRPC.",
      "parentUuid": "16627a8e_a98ed87a",
      "revId": "908418a35c5d216faffa9a18d9b6c453080ed05c",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}