{
  "comments": [
    {
      "unresolved": false,
      "key": {
        "uuid": "f79d3e56_6a7da18c",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021665
      },
      "writtenOn": "2024-09-06T18:54:50Z",
      "side": 1,
      "message": "Well, we need to carefully judge, if we need to broadcast everywhere or if we can get away with it in only some of the places...\nBut doing this change, atleast resolves the thread hungs for sure...",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "5d32ca2c_d853521b",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021774
      },
      "writtenOn": "2024-09-06T20:18:17Z",
      "side": 1,
      "message": "I am curious, is there a bug for the thread hung issue?\n\nI touched this logic recently, I hope I did not break anything :-)",
      "parentUuid": "f79d3e56_6a7da18c",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": false,
      "key": {
        "uuid": "8cbe9e4f_fb0b4c01",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021665
      },
      "writtenOn": "2024-09-07T02:58:55Z",
      "side": 1,
      "message": "Ohh, I didn\u0027t raise a github issue for this... Also, I do not see this a regression :-)\n\nThis was a new find after considering StateFDs also to do aggressive LRUs...\nSome backgrounds were discussed in https://gerrithub.io/c/ffilz/nfs-ganesha/+/1200764",
      "parentUuid": "5d32ca2c_d853521b",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "6dfd49a4_f5e02603",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021774
      },
      "writtenOn": "2024-09-09T16:35:30Z",
      "side": 1,
      "message": "If I understand correctly only one thread can do fd work at a time. Ideally the change description would have a summary of why broadcast helps, to help readers like me :-) What is this change trying to solve?\n\nAlso, it is possible some installations (e.g. my team\u0027s) will require some tuning of LRU knobs after this change + https://gerrithub.io/c/ffilz/nfs-ganesha/+/1200764. The more we understand what\u0027s going on the better.",
      "parentUuid": "8cbe9e4f_fb0b4c01",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "ba37427a_70c07fe2",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021774
      },
      "writtenOn": "2024-09-09T16:45:49Z",
      "side": 1,
      "message": "Is this solving a case where two threads are blocked trying to do FD work on a global FD, with thread1 (the reaper?) trying to close the FD and thread2 trying to (re)open it?",
      "parentUuid": "6dfd49a4_f5e02603",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    },
    {
      "unresolved": true,
      "key": {
        "uuid": "d39d3631_f76f27f6",
        "filename": "/PATCHSET_LEVEL",
        "patchSetId": 1
      },
      "lineNbr": 0,
      "author": {
        "id": 1021665
      },
      "writtenOn": "2024-09-11T08:39:27Z",
      "side": 1,
      "message": "Thanks David, for giving a look onto this issue/fix...Like I mentioned earlier, am also rethinking about this fix, as these broadcasts could cause spurious wake ups...\n\nI will update the commit messages, with proper test steps, for all the previous CRs...\n\nSo, for the second question...Yes, like you mentioned on the parallel FD usage by 2 threads, there was a hung seen in Ganesha, for which I made this changes after a short discussion with Frank... After making the LRU cleanup more aggressive, considering the state FDs as well this hung were seen, we saw that the IOs were dead hung on fsal_start_io() -\u003e fsal_start_global_io() -\u003e wait_to_start_io()...\n\nHung Analysis:\n1) Thread1: write2 -\u003e .. -\u003e wait_to_start_io, stop before the loop(io_work:1, fd_work:0) --\u003e while (atomic_fetch_int32_t(\u0026fsal_fd-\u003efd_work)\n2) Thread2: reaper -\u003e lru_try_one -\u003e close_fsal_fd -\u003e fsal_start_fd_work -\u003e increase the fd_work and stop (io_work:1, fd_work:1)\n3) Thread1: Enters above loop, since fd_work !\u003d 0, then io_work -1 and wait PTHREAD_COND_wait(\u0026fsal_fd-\u003eio_work_cond, (io_work:0, fd_work:1)\n4) Thread2: Enters the condition block to dec fd_work and return EBUSY(io_work:0, fd_work:0) -\u003e same as we found in the core file:\n        (gdb) p fsal_fd-\u003eio_work\n        $3 \u003d 0\n        (gdb) p fsal_fd-\u003efd_work\n        $4 \u003d 0\n\n5) And then nobody was trying to wake up Thread1 in this case, then more and more IO thread got hung... Hence I did a broadcast ðŸ˜Š\n\nAfter making this change, the hung was not seen later, but then we hit the FD system limit, as there was no body to clean up the stale State FDs...For fixing this, we need to add some limit for State FDs, which we do not have today in Ganesha...2M was the system FD limit...\n        (gdb) p fsal_fd_global_counter\n        $1 \u003d 56\n        (gdb) p fsal_fd_state_counter\n        $2 \u003d 199829\n\nAlso later we had bought down the below patch as well- https://gerrithub.io/c/ffilz/nfs-ganesha/+/1195471\n\nFinally, like I updated in the community call yesterday, let\u0027s hold this patch to see if there is better fix without broadcast and also more better testings...\n\nPlease lemme know your thoughts @drieber@google.com and @ffilzlnx@mindspring.com...\nLeaving a -1 for now...Though no impacts of this change - can be overridden and merged IN as well, if community agrees...",
      "parentUuid": "ba37427a_70c07fe2",
      "revId": "90f146f7dbce4910fda91c6cf5b33a084992ebdc",
      "serverId": "d5d70762-12d0-45a1-890d-524b12d3f735"
    }
  ]
}